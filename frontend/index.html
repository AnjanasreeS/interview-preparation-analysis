<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interview Prep Hub</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      margin: 0;
      padding: 30px 15px;
      text-align: center;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: #333;
    }
    .running-text {
      font-size: 1.2rem;
      color: #007bff;
      margin-bottom: 20px;
      /* Animation can be distracting, consider removing or adjusting if needed */
      /* animation: scroll 10s linear infinite; */
      white-space: nowrap;
      overflow: hidden;
      box-sizing: border-box;
      padding: 5px; /* Added padding for visibility */
      border: 1px solid #eee; /* Added border for visibility */
      background: #e9f5ff;
    }
    /* @keyframes scroll {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    } */
    .card {
      background: white;
      border-radius: 12px;
      padding: 20px;
      width: 200px;
      cursor: pointer;
      box-shadow: 0 6px 10px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.3s, border-color 0.3s;
      border: 2px solid transparent;
      display: inline-block; /* Align cards */
      vertical-align: top; /* Align cards */
      margin: 10px; /* Spacing for cards */
      text-align: center;
    }
    .card:hover {
      transform: scale(1.05);
      border-color: #007bff;
      box-shadow: 0 10px 18px rgba(0,0,0,0.15);
    }
    .section {
      font-size: larger;
      background: #fff;
      padding: 20px;
      margin: 20px auto;
      max-width: 800px;
      border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      text-align: left;
    }
    textarea {
      width: calc(100% - 22px); /* Adjust width for padding/border */
      padding: 10px;
      margin-top: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      min-height: 100px;
      resize: vertical;
      box-sizing: border-box;
    }
    button {
      background: #007bff;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
      transition: background 0.3s;
      font-weight: 500;
      font-size: 1rem;
    }
    button:hover {
      background: #0056b3;
    }
    button:disabled {
      background: #cccccc;
      cursor: not-allowed;
    }
    .feedback-item {
      margin: 15px 0;
      padding: 12px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #007bff;
    }
    .positive {
      color: #28a745;
      font-weight: bold;
    }
    .negative {
      color: #dc3545;
      font-weight: bold;
    }
    .chart-container {
      margin: 25px 0;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
    }
    .chart-wrapper {
      width: 100%;
      max-width: 400px; /* Increased max-width slightly */
      min-height: 300px; /* Use min-height */
      height: auto; /* Allow height to adjust */
      margin: 10px auto; /* Adjusted margin */
      position: relative; /* Needed for Chart.js responsiveness */
    }
    .score-display {
      font-size: 1.1rem;
      margin: 8px 0;
    }
    .improvement-tips {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-top: 20px;
    }
    .improvement-tips h3 {
      margin-top: 0;
      color: #007bff;
    }
    .improvement-tips ul {
      padding-left: 20px;
      list-style: disc; /* Ensure bullets are visible */
    }
    .alert {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px;
      background: #28a745;
      color: white;
      border-radius: 5px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      z-index: 1000;
      animation: slideIn 0.5s, fadeOut 0.5s 2.5s forwards;
    }
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; display: none; } /* Hide after fade out */
    }
    .performance-container {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-around; /* Use space-around */
      align-items: flex-start; /* Align items to top */
      margin: 20px 0;
      gap: 20px;
    }
    .performance-metrics {
      flex: 1;
      min-width: 280px; /* Adjusted min-width */
      text-align: left;
      padding: 10px;
      background: #f8f9fa;
      border-radius: 8px;
    }
    .performance-chart {
      flex: 1;
      min-width: 280px; /* Adjusted min-width */
      display: flex; /* Center chart */
      justify-content: center; /* Center chart */
      align-items: center; /* Center chart */
    }
    .question-bank {
      display: none;
      margin-top: 20px;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 5px;
      max-height: 200px;
      overflow-y: auto;
    }
    .question-item {
      padding: 10px;
      margin: 5px 0;
      background: #f8f9fa;
      border-radius: 5px;
      cursor: pointer;
      border: 1px solid #ddd;
    }
    .question-item:hover {
      background: #e9ecef;
    }
    .analysis-link {
        display: inline-block;
        margin: 10px;
        padding: 12px 20px;
        background-color: #6c757d; /* Secondary color */
        color: white;
        text-decoration: none;
        border-radius: 6px;
        font-weight: 500;
        transition: background-color 0.3s;
    }
    .analysis-link:hover {
        background-color: #5a6268;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

  <h1>Interview Prep Hub</h1>
  <div class="running-text">üöÄ You've got this! Practice makes perfect. Believe in yourself! üöÄ</div>

  <div style="display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; margin-bottom: 30px;">
    <div class="card" onclick="showTips('Technical')">üíª Technical Tips</div>
    <div class="card" onclick="showTips('HR')">üßë‚Äçüíº HR Tips</div>
    <div class="card" onclick="showTips('Behavioral')">üß† Behavioral Tips</div>
    <div class="card" onclick="showFeedback()">üìä Performance Dashboard</div>
  </div>

  <div class="section" id="tipsSection">
    <h2>Select a category to view tips or the dashboard</h2>
    </div>

  <div class="section" id="textPracticeSection">
    <h2>üéØ Mock Practice (Text)</h2>
    <button onclick="toggleQuestionBank()" id="questionBankBtn">Show Question Bank</button>
    <div class="question-bank" id="questionBank">
      <div class="question-item" onclick="setQuestion('Describe a challenging project you worked on.')">Describe a challenging project you worked on.</div>
      <div class="question-item" onclick="setQuestion('Tell me about a time you had a conflict with a team member.')">Tell me about a time you had a conflict with a team member.</div>
      <div class="question-item" onclick="setQuestion('How do you handle tight deadlines?')">How do you handle tight deadlines?</div>
      <div class="question-item" onclick="setQuestion('What is your greatest strength?')">What is your greatest strength?</div>
      <div class="question-item" onclick="setQuestion('What is your biggest weakness?')">What is your biggest weakness?</div>
      <div class="question-item" onclick="setQuestion('Why should we hire you?')">Why should we hire you?</div>
      <div class="question-item" onclick="setQuestion('Where do you see yourself in 5 years?')">Where do you see yourself in 5 years?</div>
    </div>
    <p id="currentQuestion"><strong>Q:</strong> Describe a challenging project you worked on.</p>
    <textarea id="textAnswer" rows="5" placeholder="Type your answer here... (Try to use the STAR method: Situation, Task, Action, Result)"></textarea><br>
    <button onclick="evaluateTextResponse()">Submit Answer</button>
    <div id="textFeedback" class="feedback-item" style="display: none;">
        </div>
  </div>

  <div class="section" style="text-align:center;">
    <h2>Practice Specific Skills</h2>
    <a href="index2.html" class="analysis-link">üëê Practice Gestures</a>
    <a href="index3.html" class="analysis-link">üó£ Practice Speech</a>
  </div>

  <script>
    // Global variables (initialize with defaults or from sessionStorage)
    let scores = { speech: 0, gestures: 0, text: 0 };
    // Keep references to chart instances to destroy them before re-rendering
    window.currentPieChart = null;
    window.currentRadarChart = null;

    // --- Function to save state ---
    function saveStateToSessionStorage() {
      try {
        sessionStorage.setItem('interviewScores', JSON.stringify(scores));
        sessionStorage.setItem('currentQuestionHTML', document.getElementById('currentQuestion')?.innerHTML || '');
        sessionStorage.setItem('textAnswerValue', document.getElementById('textAnswer')?.value || '');
        const textFeedbackEl = document.getElementById('textFeedback');
        sessionStorage.setItem('textFeedbackHTML', textFeedbackEl?.innerHTML || '');
        sessionStorage.setItem('textFeedbackDisplay', textFeedbackEl?.style.display || 'none');
        sessionStorage.setItem('tipsSectionHTML', document.getElementById('tipsSection')?.innerHTML || '');
        console.log("State saved:", scores); // Debug log
      } catch (e) {
        console.error("Error saving state to sessionStorage:", e);
        // Handle potential storage errors (e.g., quota exceeded)
        showAlert('Could not save session state. Storage might be full.', 'error');
      }
    }

    // --- Function to load state ---
    function loadStateFromSessionStorage() {
      try {
        const savedScores = sessionStorage.getItem('interviewScores');
        if (savedScores) {
            scores = JSON.parse(savedScores);
            console.log("Loaded scores:", scores); // Debug log
        } else {
            console.log("No saved scores found, using defaults.");
            scores = { speech: 0, gestures: 0, text: 0 }; // Ensure default if nothing is loaded
        }

        const savedQuestionHTML = sessionStorage.getItem('currentQuestionHTML');
        const currentQuestionEl = document.getElementById('currentQuestion');
        if (savedQuestionHTML && currentQuestionEl) {
          currentQuestionEl.innerHTML = savedQuestionHTML;
        } else if (currentQuestionEl) {
          // Set default if nothing saved
          currentQuestionEl.innerHTML = '<strong>Q:</strong> Describe a challenging project you worked on.';
        }


        const savedAnswerValue = sessionStorage.getItem('textAnswerValue');
        const textAnswerEl = document.getElementById('textAnswer');
        if (savedAnswerValue && textAnswerEl) {
          textAnswerEl.value = savedAnswerValue;
        }

        const savedFeedbackHTML = sessionStorage.getItem('textFeedbackHTML');
        const savedFeedbackDisplay = sessionStorage.getItem('textFeedbackDisplay');
        const textFeedbackEl = document.getElementById('textFeedback');
        if (savedFeedbackHTML && savedFeedbackDisplay && textFeedbackEl) {
            textFeedbackEl.innerHTML = savedFeedbackHTML;
            textFeedbackEl.style.display = savedFeedbackDisplay;
        }

        const savedTipsHTML = sessionStorage.getItem('tipsSectionHTML');
        const tipsSectionEl = document.getElementById('tipsSection');
        if (savedTipsHTML && tipsSectionEl) {
            tipsSectionEl.innerHTML = savedTipsHTML;
            // IMPORTANT: If the dashboard was showing, re-render the charts
            if (savedTipsHTML.includes('id="pieChart"') && savedTipsHTML.includes('id="radarChart"')) {
                // Delay slightly to ensure DOM elements are fully ready for Chart.js
                 setTimeout(() => {
                    console.log("Re-rendering charts from loaded state.");
                    renderFeedbackCharts();
                 }, 150); // Increased delay slightly
            }
        } else if (tipsSectionEl) {
            // If no tips section state saved, show default Behavioral tips
            console.log("No saved tips/dashboard view, showing default tips.");
            showTips('Behavioral', false); // Call without saving state initially
        }
      } catch (e) {
          console.error("Error loading state from sessionStorage:", e);
          scores = { speech: 0, gestures: 0, text: 0 }; // Reset scores on error
          // Optionally clear potentially corrupted storage
          // sessionStorage.clear();
          // Show default tips on error
          showTips('Behavioral', false);
      }
    }

    // Show alert notification
    function showAlert(message, type = 'success') {
      const alertId = 'alert-' + Date.now(); // Unique ID for each alert
      // Remove existing alerts of the same type to prevent stacking
      // document.querySelectorAll(`.alert.${type}`).forEach(el => el.remove());

      const alertDiv = document.createElement('div');
      alertDiv.id = alertId;
      alertDiv.className = `alert ${type === 'error' ? 'negative' : 'positive'}`; // Use existing color classes maybe?
      alertDiv.style.background = type === 'error' ? '#dc3545' : '#28a745'; // Explicit background
      alertDiv.textContent = message;
      document.body.appendChild(alertDiv);

      // Set timeout to remove the specific alert
      setTimeout(() => {
        const elToRemove = document.getElementById(alertId);
        if(elToRemove) {
            // Optional: Add fade-out animation before removing
             elToRemove.style.opacity = '0';
             setTimeout(() => elToRemove.remove(), 500); // Remove after fade
        }
      }, 3000);
    }

    // Toggle question bank visibility
    function toggleQuestionBank() {
      const bank = document.getElementById('questionBank');
      const btn = document.getElementById('questionBankBtn');
      if (!bank || !btn) return; // Element check

      if (bank.style.display === 'block') {
        bank.style.display = 'none';
        btn.textContent = 'Show Question Bank';
      } else {
        bank.style.display = 'block';
        btn.textContent = 'Hide Question Bank';
      }
      // No state save needed here
    }

    // Set question from bank
    function setQuestion(question) {
      const currentQuestionEl = document.getElementById('currentQuestion');
      if (!currentQuestionEl) return; // Element check

      currentQuestionEl.innerHTML = `<strong>Q:</strong> ${question}`;
      toggleQuestionBank(); // Hide bank after selection
      // --- Save state after setting question ---
      saveStateToSessionStorage();
    }

    // Show tips for different categories
    function showTips(type, shouldSaveState = true) { // Added flag to control saving
      const tipsSectionEl = document.getElementById('tipsSection');
      if (!tipsSectionEl) return; // Element check

      const tips = {
         Technical: [
           "Master data structures and algorithms (Big O notation).",
           "Review your past projects: challenges, solutions, outcomes.",
           "Prepare for system design: scalability, availability, trade-offs.",
           "Practice coding on a whiteboard or text editor (explain your thought process).",
           "Know your primary programming language and tech stack deeply.",
           "Be ready to debug code snippets or explain concepts."
         ],
         HR: [
           "Research the company: mission, values, recent news, products/services.",
           "Prepare answers for 'Tell me about yourself', strengths/weaknesses.",
           "Have 2-3 thoughtful questions ready for the interviewer about the role/team/company.",
           "Be honest, authentic, and show genuine enthusiasm.",
           "Align your background and goals with the job description and company culture.",
           "Prepare your salary expectations (research benchmarks)."
         ],
         Behavioral: [
           "Use the STAR method: Situation, Task, Action, Result.",
           "Prepare 5-7 specific stories: teamwork, conflict, failure, success, leadership, initiative.",
           "Focus on *your* specific contributions and the measurable impact.",
           "Quantify results whenever possible (e.g., 'improved efficiency by 15%').",
           "Show self-awareness and what you learned from each experience.",
           "Listen carefully to the question and tailor your STAR story accordingly."
         ]
       };

      if (!tips[type]) {
          console.error("Invalid tips type:", type);
          return;
      }

      let tipsHTML = `<h2>${type} Interview Tips</h2><ul>`;
      tips[type].forEach(tip => {
        tipsHTML += `<li>${tip}</li>`;
      });
      tipsHTML += "</ul>";

      tipsSectionEl.innerHTML = tipsHTML;

      // --- Save state only if requested ---
      if (shouldSaveState) {
          saveStateToSessionStorage();
      }
    }

    // Show overall feedback dashboard
    function showFeedback() {
      const tipsSectionEl = document.getElementById('tipsSection');
      if (!tipsSectionEl) return; // Element check

      // Ensure scores are up-to-date by re-loading from session storage
      // (in case index2/index3 updated them since last load/save on this page)
      const savedScores = sessionStorage.getItem('interviewScores');
      if (savedScores) {
         try {
             scores = JSON.parse(savedScores);
             console.log("Refreshed scores before showing dashboard:", scores);
         } catch (e) {
              console.error("Error parsing scores before showing feedback:", e);
              // Use potentially stale scores if parse fails, or reset? Let's use stale for now.
         }
      }

      const overallScore = Math.round(( (scores.speech || 0) + (scores.gestures || 0) + (scores.text || 0)) / 3);

      let feedbackHTML = `
        <h2>Your Interview Performance Dashboard</h2>

        <div class="performance-container">
          <div class="performance-metrics">
            <h3>Performance Metrics</h3>
            <div class="score-display">
              <strong>Speech Clarity:</strong> ${scores.speech || 0}% ${getScoreEmoji(scores.speech || 0)}
            </div>
            <div class="score-display">
              <strong>Response Quality (Text):</strong> ${scores.text || 0}% ${getScoreEmoji(scores.text || 0)}
            </div>
            <div class="score-display">
              <strong>Body Language (Gestures):</strong> ${scores.gestures || 0}% ${getScoreEmoji(scores.gestures || 0)}
            </div>
          </div>

          <div class="performance-chart">
            <div class="chart-wrapper">
              <canvas id="pieChart"></canvas> </div>
          </div>
        </div>

        <div style="text-align: center; margin: 25px 0; padding: 15px; background: #f0f4f8; border-radius: 8px; border: 1px solid #ddd;">
          <h3>Overall Score: <span style="color: ${getScoreColor(overallScore)}; font-size: 1.3em;">${overallScore}% ${getScoreEmoji(overallScore)}</span></h3>
          <p style="font-size: 1.1em;">${getOverallFeedback(overallScore)}</p>
        </div>

        <div class="chart-wrapper" style="max-width: 500px;"> <canvas id="radarChart"></canvas>
        </div>

        <div class="improvement-tips">
          <h3>Personalized Improvement Tips</h3>
          <ul>
            ${getImprovementTips(scores)}
          </ul>
        </div>
      `;

      tipsSectionEl.innerHTML = feedbackHTML;
      // Render charts *after* the HTML is in the DOM
      // Use a small delay to ensure elements are rendered
       setTimeout(() => {
            console.log("Rendering charts for dashboard.");
            renderFeedbackCharts();
       }, 50); // Short delay

      // --- Save state after showing feedback dashboard ---
      saveStateToSessionStorage();
    }

    // Helper: Get score color
    function getScoreColor(score) {
      if (score >= 85) return '#28a745'; // Green
      if (score >= 70) return '#ffc107'; // Yellow
      return '#dc3545'; // Red
    }

    // Helper: Get score emoji
    function getScoreEmoji(score) {
      if (score >= 85) return 'üòä'; // Excellent
      if (score >= 70) return 'üôÇ'; // Good
      return 'üòü'; // Needs Improvement
    }

    // Helper: Get overall text feedback
    function getOverallFeedback(score) {
      if (score >= 85) return "<span class='positive'>Excellent work! You demonstrate strong interview skills across the board.</span>";
      if (score >= 70) return "Good performance! Focus on the areas highlighted in the tips for further improvement.";
      return "<span class='negative'>Needs more practice. Review the tips carefully and try the exercises again. Consistency is key!</span>";
    }

    // Helper: Get personalized improvement tips
    function getImprovementTips(currentScores) {
       let tips = [];
       if ((currentScores.speech || 0) < 70) tips.push(`<li>Work on <strong>Speech Clarity</strong>: Practice enunciating clearly, vary your pace, and use pauses effectively. Record yourself speaking. (Current: ${currentScores.speech || 0}%)</li>`);
       if ((currentScores.gestures || 0) < 70) tips.push(`<li>Improve <strong>Body Language</strong>: Maintain good posture (sit up straight), make consistent eye contact (look towards the camera), and use natural hand gestures. Avoid fidgeting. (Current: ${currentScores.gestures || 0}%)</li>`);
       if ((currentScores.text || 0) < 70) tips.push(`<li>Refine <strong>Response Quality</strong>: Ensure your answers fully address the question. Practice structuring answers using the STAR method, especially for behavioral questions. Add specific details and quantify results. (Current: ${currentScores.text || 0}%)</li>`);

       if (tips.length === 0) return "<li>You're doing great! Keep practicing to maintain consistency and confidence. Consider refining advanced techniques like storytelling and handling complex questions.</li>";
       return tips.join('');
    }

    // Text evaluation
    function evaluateTextResponse() {
      const answerEl = document.getElementById("textAnswer");
      const feedbackEl = document.getElementById("textFeedback");
      if (!answerEl || !feedbackEl) return; // Element check

      const answer = answerEl.value.trim();
      if (!answer) {
        showAlert("Please enter your answer first!", "error");
        return;
      }

      // Simple scoring logic (Refine as needed)
      const wordCount = answer.split(/\s+/).length;
      const hasStarKeywords = /situation|task|action|result|challenge|approach|outcome|learned/i.test(answer);
      const lengthScore = Math.min(wordCount * 0.8, 50); // Max 50 points for length (e.g., >60 words)
      const starScore = hasStarKeywords ? 30 : 0; // 30 points for using STAR keywords
      const baseScore = 20; // Base points for attempting
      let score = Math.min(lengthScore + starScore + baseScore, 100); // Cap at 100

      scores.text = Math.round(score);

      // Provide feedback
      let feedbackContent = `<strong>Text Score: ${scores.text}% ${getScoreEmoji(scores.text)}</strong><br>`;
      if (wordCount < 50) {
         feedbackContent += `<span class='negative'>Consider elaborating more. Aim for 50+ words for detailed answers. (Words: ${wordCount})</span><br>`;
      } else {
         feedbackContent += `<span class='positive'>Good level of detail. (Words: ${wordCount})</span><br>`;
      }
      if (!hasStarKeywords) {
         feedbackContent += "<span class='negative'>Try structuring your answer using the STAR method (Situation, Task, Action, Result) for behavioral questions. Mentioning keywords like 'challenge', 'approach', 'outcome' helps.</span>";
      } else {
         feedbackContent += "<span class='positive'>Good structure, likely using STAR elements.</span>";
      }

      feedbackEl.innerHTML = feedbackContent;
      feedbackEl.style.display = "block";

      showAlert("Text answer evaluated!");

      // --- Save state after text evaluation ---
      saveStateToSessionStorage();

      // If dashboard is currently shown, update it dynamically
      if (document.getElementById('tipsSection')?.innerHTML.includes('id="pieChart"')) {
        console.log("Dashboard is visible, updating it after text evaluation.");
        showFeedback(); // This will re-load latest scores, re-render with the new text score, and save state again
      }
    }


    // Chart rendering function
    function renderFeedbackCharts() {
       // Ensure chart containers exist before trying to render
       const pieCanvas = document.getElementById('pieChart');
       const radarCanvas = document.getElementById('radarChart');

       if (!pieCanvas || !radarCanvas) {
           console.warn("Chart canvas elements not found in the DOM, skipping chart rendering.");
           return; // Don't try to render if the dashboard isn't visible or elements are missing
       }

        const pieCtx = pieCanvas.getContext('2d');
        const radarCtx = radarCanvas.getContext('2d');

       // Destroy existing charts if they exist, to prevent memory leaks and overlapping charts
        if (window.currentPieChart instanceof Chart) {
            console.log("Destroying previous Pie Chart.");
            window.currentPieChart.destroy();
        }
        if (window.currentRadarChart instanceof Chart) {
            console.log("Destroying previous Radar Chart.");
            window.currentRadarChart.destroy();
        }

        // --- Pie Chart ---
        try {
             window.currentPieChart = new Chart(pieCtx, {
                 type: 'pie',
                 data: {
                     labels: ['Speech', 'Content (Text)', 'Body Language'],
                     datasets: [{
                         // Ensure scores are numbers, default to 0 if undefined/null
                         data: [scores.speech || 0, scores.text || 0, scores.gestures || 0],
                         backgroundColor: [ getScoreColor(scores.speech || 0), getScoreColor(scores.text || 0), getScoreColor(scores.gestures || 0)],
                         borderColor: '#ffffff', // White border for separation
                         borderWidth: 2
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false, // Important for wrapper resizing
                     plugins: {
                         legend: { position: 'top', labels: { padding: 15 } },
                         title: { display: true, text: 'Score Distribution', padding: { top: 10, bottom: 10 } },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     let label = context.label || '';
                                     if (label) {
                                         label += ': ';
                                     }
                                     if (context.parsed !== null) {
                                         label += context.parsed + '%';
                                     }
                                     return label;
                                 }
                             }
                         }
                     }
                 }
             });
             console.log("Pie chart rendered successfully.");
        } catch(e) {
            console.error("Error rendering Pie chart:", e);
        }


       // --- Radar Chart ---
        try {
             window.currentRadarChart = new Chart(radarCtx, {
                 type: 'radar',
                 data: {
                     labels: ['Clarity (Speech)', 'Content (Text)', 'Confidence (Avg)', 'Structure (Text)', 'Body Language'],
                     datasets: [{
                         label: 'Your Performance',
                         // Ensure data points are numbers and within 0-100
                         data: [
                             Math.max(0, Math.min(100, scores.speech || 0)),
                             Math.max(0, Math.min(100, scores.text || 0)),
                             Math.max(0, Math.min(100, ((scores.speech || 0) + (scores.gestures || 0)) / 2)), // Confidence as avg
                             Math.max(0, Math.min(100, (scores.text || 0) * 0.7 + ((scores.text || 0) > 50 ? 30 : 0) )), // Simplified structure score based on text score
                             Math.max(0, Math.min(100, scores.gestures || 0))
                         ],
                         backgroundColor: 'rgba(0, 123, 255, 0.2)',
                         borderColor: '#007bff',
                         pointBackgroundColor: '#007bff',
                         pointBorderColor: '#fff',
                         pointHoverBackgroundColor: '#fff',
                         pointHoverBorderColor: '#007bff',
                         borderWidth: 2,
                         pointRadius: 4 // Make points slightly larger
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false, // Important for wrapper resizing
                     scales: {
                         r: {
                             angleLines: { color: 'rgba(0, 0, 0, 0.1)' }, // Lighter angle lines
                             grid: { color: 'rgba(0, 0, 0, 0.1)' }, // Lighter grid lines
                             suggestedMin: 0,
                             suggestedMax: 100,
                             pointLabels: { font: { size: 11 }, color: '#333' }, // Style point labels
                             ticks: {
                                backdropColor: 'rgba(255, 255, 255, 0.75)', // Background for ticks
                                color: '#666', // Tick label color
                                stepSize: 20 // Ticks every 20 points
                             }
                         }
                     },
                     plugins: {
                         legend: { display: false }, // Hide legend for radar if dataset label is clear
                         title: { display: true, text: 'Performance Aspects Radar', padding: { top: 10, bottom: 10 } },
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     return context.dataset.label + ': ' + context.formattedValue + '%';
                                 }
                             }
                         }
                     }
                 }
             });
             console.log("Radar chart rendered successfully.");
        } catch(e) {
            console.error("Error rendering Radar chart:", e);
        }
    }

    // --- Load initial state when the page DOM is ready ---
    document.addEventListener('DOMContentLoaded', () => {
         console.log("DOM fully loaded and parsed. Loading state...");
         loadStateFromSessionStorage();
         // Note: loadStateFromSessionStorage now handles showing default tips or the dashboard
         // based on saved state, so no explicit call to showTips('Behavioral') is needed here
         // unless loadState fails entirely.
         console.log("Initial state loaded.");
    });

    // --- Add event listener to save state before leaving the page ---
    // This is a best-effort attempt, as browser support/behavior can vary.
    window.addEventListener('beforeunload', (event) => {
        console.log("beforeunload event triggered. Saving state...");
        saveStateToSessionStorage();
        // Note: You cannot reliably prevent the user from leaving or perform async operations here.
        // Just save the state synchronously.
    });

  </script>

</body>
</html>
